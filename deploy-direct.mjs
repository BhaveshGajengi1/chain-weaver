import { ethers } from 'ethers';
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Contract bytecode and ABI
const CONTRACT_JSON = {
    "abi": [
        {
            "type": "function",
            "name": "storePixels",
            "stateMutability": "nonpayable",
            "inputs": [
                { "name": "_pixelData", "type": "bytes" },
                { "name": "_metadata", "type": "string" }
            ],
            "outputs": [{ "name": "", "type": "uint256" }]
        },
        {
            "type": "function",
            "name": "getCanvas",
            "stateMutability": "view",
            "inputs": [{ "name": "canvasId", "type": "uint256" }],
            "outputs": [
                { "name": "_pixelData", "type": "bytes" },
                { "name": "_metadata", "type": "string" },
                { "name": "_creator", "type": "address" },
                { "name": "_timestamp", "type": "uint256" }
            ]
        },
        {
            "type": "function",
            "name": "getCanvasCount",
            "stateMutability": "view",
            "inputs": [],
            "outputs": [{ "name": "", "type": "uint256" }]
        },
        {
            "type": "function",
            "name": "getCreator",
            "stateMutability": "view",
            "inputs": [{ "name": "canvasId", "type": "uint256" }],
            "outputs": [{ "name": "", "type": "address" }]
        },
        {
            "type": "event",
            "name": "CanvasStored",
            "inputs": [
                { "name": "canvasId", "type": "uint256", "indexed": true },
                { "name": "creator", "type": "address", "indexed": true },
                { "name": "timestamp", "type": "uint256", "indexed": false }
            ]
        }
    ],
    // Compiled bytecode for DataLoom contract
    "bytecode": "0x608060405234801561000f575f5ffd5b50610fc78061001d5f395ff3fe608060405234801561000f575f5ffd5b5060043610610091575f3560e01c80638bc33af3116100645780638bc33af314610134578063a876a88d14610164578063cd53d08e14610194578063d48e638a146101c4578063e3684e39146101f457610091565b80631b36c6ac146100955780632c54e6d9146100c557806345d7e405146100e35780634f6d39ce14610116575b5f5ffd5b6100af60048036038101906100aa91906106ce565b610224565b6040516100bc9190610769565b60405180910390f35b6100cd6102bf565b6040516100da9190610798565b60405180910390f35b6100fd60048036038101906100f891906106ce565b6102c7565b60405161010d9493929190610842565b60405180910390f35b61011e610454565b60405161012b9190610798565b60405180910390f35b61014e600480360381019061014991906106ce565b610459565b60405161015b9190610798565b60405180910390f35b61017e60048036038101906101799190610a5d565b61046e565b60405161018b9190610798565b60405180910390f35b6101ae60048036038101906101a991906106ce565b610586565b6040516101bb9190610ad3565b60405180910390f35b6101de60048036038101906101d991906106ce565b6105b6565b6040516101eb9190610ad3565b60405180910390f35b61020e600480360381019061020991906106ce565b6105ef565b60405161021b9190610aec565b60405180910390f35b6001602052805f5260405f205f91509050805461024090610b39565b80601f016020809104026020016040519081016040528092919081815260200182805461026c90610b39565b80156102b75780601f1061028e576101008083540402835291602001916102b7565b820191905f5260205f20905b81548152906001019060200180831161029a57829003601f168201915b505050505081565b5f5f54905090565b6060805f5f60015f8681526020019081526020015f2060025f8781526020019081526020015f2060035f8881526020019081526020015f205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660045f8981526020019081526020015f205483805461033d90610b39565b80601f016020809104026020016040519081016040528092919081815260200182805461036990610b39565b80156103b45780601f1061038b576101008083540402835291602001916103b4565b820191905f5260205f20905b81548152906001019060200180831161039757829003601f168201915b505050505093508280546103c790610b39565b80601f01602080910402602001604051908101604052809291908181526020018280546103f390610b39565b801561043e5780601f106104155761010080835404028352916020019161043e565b820191905f5260205f20905b81548152906001019060200180831161042157829003601f168201915b5050505050925093509350935093509193509193565b5f5481565b6004602052805f5260405f205f915090505481565b5f5f5f81548092919061048090610b96565b91905055505f5f5490508360015f8381526020019081526020015f2090816104a89190610d8e565b508260025f8381526020019081526020015f2090816104c79190610ec2565b503360035f8381526020019081526020015f205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055504260045f8381526020019081526020015f20819055503373ffffffffffffffffffffffffffffffffffffffff16817f401b3aea89e3203fa3a631702bff54a2ac875d0b4c98022ced977ed65bc1c6e9426040516105749190610798565b60405180910390a38091505092915050565b6003602052805f5260405f205f915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f60035f8381526020019081526020015f205f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6002602052805f5260405f205f91509050805461060b90610b39565b80601f016020809104026020016040519081016040528092919081815260200182805461063790610b39565b80156106825780601f1061065957610100808354040283529160200191610682565b820191905f5260205f20905b81548152906001019060200180831161066557829003601f168201915b505050505081565b5f604051905090565b5f5ffd5b5f5ffd5b5f819050919050565b6106ad8161069b565b81146106b7575f5ffd5b50565b5f813590506106c8816106a4565b92915050565b5f602082840312156106e3576106e2610693565b5b5f6106f0848285016106ba565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61073b826106f9565b6107458185610703565b9350610755818560208601610713565b61075e81610721565b840191505092915050565b5f6020820190508181035f8301526107818184610731565b905092915050565b6107928161069b565b82525050565b5f6020820190506107ab5f830184610789565b92915050565b5f81519050919050565b5f82825260208201905092915050565b5f6107d5826107b1565b6107df81856107bb565b93506107ef818560208601610713565b6107f881610721565b840191505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61082c82610803565b9050919050565b61083c81610822565b82525050565b5f6080820190508181035f83015261085a8187610731565b9050818103602083015261086e81866107cb565b905061087d6040830185610833565b61088a6060830184610789565b95945050505050565b5f5ffd5b5f5ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6108d182610721565b810181811067ffffffffffffffff821117156108f0576108ef61089b565b5b80604052505050565b5f61090261068a565b905061090e82826108c8565b919050565b5f67ffffffffffffffff82111561092d5761092c61089b565b5b61093682610721565b9050602081019050919050565b828183375f83830152505050565b5f61096361095e84610913565b6108f9565b90508281526020810184848401111561097f5761097e610897565b5b61098a848285610943565b509392505050565b5f82601f8301126109a6576109a5610893565b5b81356109b6848260208601610951565b91505092915050565b5f67ffffffffffffffff8211156109d9576109d861089b565b5b6109e282610721565b9050602081019050919050565b5f610a016109fc846109bf565b6108f9565b905082815260208101848484011115610a1d57610a1c610897565b5b610a28848285610943565b509392505050565b5f82601f830112610a4457610a43610893565b5b8135610a548482602086016109ef565b91505092915050565b5f5f60408385031215610a7357610a72610693565b5b5f83013567ffffffffffffffff811115610a9057610a8f610697565b5b610a9c85828601610992565b925050602083013567ffffffffffffffff811115610abd57610abc610697565b5b610ac985828601610a30565b9150509250929050565b5f602082019050610ae65f830184610833565b92915050565b5f6020820190508181035f830152610b0481846107cb565b905092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610b5057607f821691505b602082108103610b6357610b62610b0c565b5b50919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610ba08261069b565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610bd257610bd1610b69565b5b600182019050919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302610c397fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610bfe565b610c438683610bfe565b95508019841693508086168417925050509392505050565b5f819050919050565b5f610c7e610c79610c748461069b565b610c5b565b61069b565b9050919050565b5f819050919050565b610c9783610c64565b610cab610ca382610c85565b848454610c0a565b825550505050565b5f5f905090565b610cc2610cb3565b610ccd818484610c8e565b505050565b5f5b82811015610cf357610ce85f828401610cba565b600181019050610cd4565b505050565b601f821115610d465782821115610d4557610d1281610bdd565b610d1b83610bef565b610d2485610bef565b6020861015610d31575f90505b808301610d4082840382610cd2565b505050505b5b505050565b5f82821c905092915050565b5f610d665f1984600802610d4b565b1980831691505092915050565b5f610d7e8383610d57565b9150826002028217905092915050565b610d97826106f9565b67ffffffffffffffff811115610db057610daf61089b565b5b610dba8254610b39565b610dc5828285610cf8565b5f60209050601f831160018114610df6575f8415610de4578287015190505b610dee8582610d73565b865550610e55565b601f198416610e0486610bdd565b5f5b82811015610e2b57848901518255600182019150602085019450602081019050610e06565b86831015610e485784890151610e44601f891682610d57565b8355505b6001600288020188555050505b505050505050565b5f819050815f5260205f209050919050565b601f821115610ebd5782821115610ebc57610e8981610e5d565b610e9283610bef565b610e9b85610bef565b6020861015610ea8575f90505b808301610eb782840382610cd2565b505050505b5b505050565b610ecb826107b1565b67ffffffffffffffff811115610ee457610ee361089b565b5b610eee8254610b39565b610ef9828285610e6f565b5f60209050601f831160018114610f2a575f8415610f18578287015190505b610f228582610d73565b865550610f89565b601f198416610f3886610e5d565b5f5b82811015610f5f57848901518255600182019150602085019450602081019050610f3a565b86831015610f7c5784890151610f78601f891682610d57565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220a52aed7a2d5f255b9e1a6c040acfc403d6711b9435bbd3294a956eb1dd41cbe764736f6c63430008210033"
};

async function deployContract() {
    console.log('üöÄ Deploying DataLoom to Arbitrum Sepolia...\n');

    const RPC_URL = 'https://sepolia-rollup.arbitrum.io/rpc';
    const PRIVATE_KEY = 'b41ef693797033b5405ade48be72dce26287d5e241e13bfddb918285939581d9';

    // Setup provider and wallet
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

    console.log('üìç Deploying from:', wallet.address);

    // Check balance
    const balance = await provider.getBalance(wallet.address);
    console.log('üí∞ Balance:', ethers.formatEther(balance), 'ETH\n');

    if (balance === 0n) {
        console.log('‚ùå ERROR: No ETH in wallet!');
        console.log('Get testnet ETH from: https://faucet.quicknode.com/arbitrum/sepolia');
        process.exit(1);
    }

    // Create contract factory
    const factory = new ethers.ContractFactory(
        CONTRACT_JSON.abi,
        CONTRACT_JSON.bytecode,
        wallet
    );

    console.log('üìù Deploying contract...');

    // Deploy
    const contract = await factory.deploy();
    console.log('‚è≥ Waiting for deployment transaction...');

    await contract.waitForDeployment();

    const address = await contract.getAddress();

    console.log('\n‚úÖ DataLoom deployed successfully!');
    console.log('üìç Contract Address:', address);
    console.log('üîó Transaction Hash:', contract.deploymentTransaction().hash);

    console.log('\n‚è≥ Waiting for 3 confirmations...');
    await contract.deploymentTransaction().wait(3);

    console.log('‚úÖ Confirmed!\n');
    console.log('üéâ Deployment complete!');
    console.log('\nüìã Next steps:');
    console.log('1. Update src/lib/contracts.ts with this address:');
    console.log(`   [arbitrumSepolia.id]: "${address}" as \`0x\${string}\`,`);
    console.log('\n2. View on Arbiscan:');
    console.log(`   https://sepolia.arbiscan.io/address/${address}`);

    // Save to file
    fs.writeFileSync('deployed-address.txt', address);
    console.log('\nüíæ Address saved to deployed-address.txt');
}

deployContract().catch((error) => {
    console.error('\n‚ùå Deployment failed:');
    console.error(error);
    process.exit(1);
});
